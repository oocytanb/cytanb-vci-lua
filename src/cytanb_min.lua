-- cytanb | Copyright (c) 2019 oO (https://github.com/oocytanb) | MIT Licensed
---@type cytanb @See `cytanb_annotations.lua`
local cytanb=(function()math.randomseed(os.time()-os.clock()*10000)local b='__CYTANB_INSTANCE_ID'local c;local d;local e;local f=false;local g;local h;local a;local i=function(j,k)for l=1,4 do local m=j[l]-k[l]if m~=0 then return m end end;return 0 end;local n;n={__eq=function(j,k)return j[1]==k[1]and j[2]==k[2]and j[3]==k[3]and j[4]==k[4]end,__lt=function(j,k)return i(j,k)<0 end,__le=function(j,k)return i(j,k)<=0 end,__tostring=function(o)local p=o[2]or 0;local q=o[3]or 0;return string.format('%08x-%04x-%04x-%04x-%04x%08x',bit32.band(o[1]or 0,0xFFFFFFFF),bit32.band(bit32.rshift(p,16),0xFFFF),bit32.band(p,0xFFFF),bit32.band(bit32.rshift(q,16),0xFFFF),bit32.band(q,0xFFFF),bit32.band(o[4]or 0,0xFFFFFFFF))end,__concat=function(j,k)local r=getmetatable(j)local s=r==n or type(r)=='table'and r.__concat==n.__concat;local t=getmetatable(k)local u=t==n or type(t)=='table'and t.__concat==n.__concat;if not s and not u then error('attempt to concatenate illegal values',2)end;return(s and n.__tostring(j)or j)..(u and n.__tostring(k)or k)end}local v='__CYTANB_CONST_VARIABLES'local w=function(table,x)local y=getmetatable(table)if y then local z=rawget(y,v)if z then local A=rawget(z,x)if type(A)=='function'then return A(table,x)else return A end end end;return nil end;local B=function(table,x,C)local y=getmetatable(table)if y then local z=rawget(y,v)if z then if rawget(z,x)~=nil then error('Cannot assign to read only field "'..x..'"',2)end end end;rawset(table,x,C)end;local D=function(E)return string.gsub(string.gsub(E,a.EscapeSequenceTag,a.EscapeSequenceTag..a.EscapeSequenceTag),'/',a.SolidusTag)end;local F=function(E,G)local H=string.len(E)local I=string.len(a.EscapeSequenceTag)if I>H then return E end;local J=''local l=1;while l<H do local K,L=string.find(E,a.EscapeSequenceTag,l,true)if not K then if l==1 then J=E else J=J..string.sub(E,l)end;break end;if K>l then J=J..string.sub(E,l,K-1)end;local M=false;for N,O in ipairs(c)do local P,Q=string.find(E,O.pattern,K)if P then J=J..(G and G(O.tag)or O.replacement)l=Q+1;M=true;break end end;if not M then J=J..a.EscapeSequenceTag;l=L+1 end end;return J end;a={InstanceID=function()if h==''then h=vci.state.Get(b)or''end;return h end,NillableHasValue=function(R)return R~=nil end,NillableValue=function(R)if R==nil then error('value is nil',2)end;return R end,NillableValueOrDefault=function(R,S)if R==nil then if S==nil then error('defaultValue is nil',2)end;return S else return R end end,SetConst=function(T,U,o)if type(T)~='table'then error('Cannot set const to non-table target',2)end;local V=getmetatable(T)local y=V or{}local W=rawget(y,v)if rawget(T,U)~=nil then error('Non-const field "'..U..'" already exists',2)end;if not W then W={}rawset(y,v,W)y.__index=w;y.__newindex=B end;rawset(W,U,o)if not V then setmetatable(T,y)end;return T end,SetConstEach=function(T,X)for Y,C in pairs(X)do a.SetConst(T,Y,C)end;return T end,Extend=function(T,Z,_,a0,a1)if T==Z or type(T)~='table'or type(Z)~='table'then return T end;if _ then if not a1 then a1={}end;if a1[Z]then error('circular reference')end;a1[Z]=true end;for Y,C in pairs(Z)do if _ and type(C)=='table'then local a2=T[Y]T[Y]=a.Extend(type(a2)=='table'and a2 or{},C,_,a0,a1)else T[Y]=C end end;if not a0 then local a3=getmetatable(Z)if type(a3)=='table'then if _ then local a4=getmetatable(T)setmetatable(T,a.Extend(type(a4)=='table'and a4 or{},a3,true))else setmetatable(T,a3)end end end;if _ then a1[Z]=nil end;return T end,Vars=function(C,a5,a6,a1)local a7;if a5 then a7=a5~='__NOLF'else a5='  'a7=true end;if not a6 then a6=''end;if not a1 then a1={}end;local a8=type(C)if a8=='table'then a1[C]=a1[C]and a1[C]+1 or 1;local a9=a7 and a6 ..a5 or''local E='('..tostring(C)..') {'local aa=true;for x,ab in pairs(C)do if aa then aa=false else E=E..(a7 and','or', ')end;if a7 then E=E..'\n'..a9 end;if type(ab)=='table'and a1[ab]and a1[ab]>0 then E=E..x..' = ('..tostring(ab)..')'else E=E..x..' = '..a.Vars(ab,a5,a9,a1)end end;if not aa and a7 then E=E..'\n'..a6 end;E=E..'}'a1[C]=a1[C]-1;if a1[C]<=0 then a1[C]=nil end;return E elseif a8=='function'or a8=='thread'or a8=='userdata'then return'('..a8 ..')'elseif a8=='string'then return'('..a8 ..') '..string.format('%q',C)else return'('..a8 ..') '..tostring(C)end end,GetLogLevel=function()return e end,SetLogLevel=function(ac)e=ac end,IsOutputLogLevelEnabled=function()return f end,SetOutputLogLevelEnabled=function(ad)f=not not ad end,Log=function(ac,...)if ac<=e then local ae=f and(g[ac]or'LOG LEVEL '..tostring(ac))..' | 'or''local af=table.pack(...)if af.n==1 then local C=af[1]if C~=nil then local E=type(C)=='table'and a.Vars(C)or tostring(C)print(f and ae..E or E)else print(ae)end else local E=ae;for l=1,af.n do local C=af[l]if C~=nil then E=E..(type(C)=='table'and a.Vars(C)or tostring(C))end end;print(E)end end end,LogFatal=function(...)a.Log(a.LogLevelFatal,...)end,LogError=function(...)a.Log(a.LogLevelError,...)end,LogWarn=function(...)a.Log(a.LogLevelWarn,...)end,LogInfo=function(...)a.Log(a.LogLevelInfo,...)end,LogDebug=function(...)a.Log(a.LogLevelDebug,...)end,LogTrace=function(...)a.Log(a.LogLevelTrace,...)end,FatalLog=function(...)a.LogFatal(...)end,ErrorLog=function(...)a.LogError(...)end,WarnLog=function(...)a.LogWarn(...)end,InfoLog=function(...)a.LogInfo(...)end,DebugLog=function(...)a.LogDebug(...)end,TraceLog=function(...)a.LogTrace(...)end,ListToMap=function(ag,ah)local table={}local ai=ah==nil;for Y,C in pairs(ag)do table[C]=ai and C or ah end;return table end,Round=function(aj,ak)if ak then local al=10^ak;return math.floor(aj*al+0.5)/al else return math.floor(aj+0.5)end end,Clamp=function(o,am,an)return math.max(am,math.min(o,an))end,Lerp=function(ao,ap,a8)if a8<=0.0 then return ao elseif a8>=1.0 then return ap else return ao+(ap-ao)*a8 end end,LerpUnclamped=function(ao,ap,a8)if a8==0.0 then return ao elseif a8==1.0 then return ap else return ao+(ap-ao)*a8 end end,PingPong=function(a8,aq)if aq==0 then return 0 end;local ar=math.floor(a8/aq)local as=a8-ar*aq;if ar<0 then if(ar+1)%2==0 then return aq-as else return as end else if ar%2==0 then return as else return aq-as end end end,VectorApproximatelyEquals=function(at,au)return(at-au).sqrMagnitude<1E-10 end,QuaternionApproximatelyEquals=function(at,au)local av=Quaternion.Dot(at,au)return av<1.0+1E-06 and av>1.0-1E-06 end,QuaternionToAngleAxis=function(aw)local ar=aw.normalized;local ax=math.acos(ar.w)local ay=math.sin(ax)local az=math.deg(ax*2.0)local aA;if math.abs(ay)<=Quaternion.kEpsilon then aA=Vector3.right else local aB=1.0/ay;aA=Vector3.__new(ar.x*aB,ar.y*aB,ar.z*aB)end;return az,aA end,ApplyQuaternionToVector3=function(aw,aC)local aD=aw.w*aC.x+aw.y*aC.z-aw.z*aC.y;local aE=aw.w*aC.y-aw.x*aC.z+aw.z*aC.x;local aF=aw.w*aC.z+aw.x*aC.y-aw.y*aC.x;local aG=-aw.x*aC.x-aw.y*aC.y-aw.z*aC.z;return Vector3.__new(aG*-aw.x+aD*aw.w+aE*-aw.z-aF*-aw.y,aG*-aw.y-aD*-aw.z+aE*aw.w+aF*-aw.x,aG*-aw.z+aD*-aw.y-aE*-aw.x+aF*aw.w)end,RotateAround=function(aH,aI,aJ,aK)return aJ+a.ApplyQuaternionToVector3(aK,aH-aJ),aK*aI end,Random32=function()return bit32.band(math.random(-2147483648,2147483646),0xFFFFFFFF)end,RandomUUID=function()return a.UUIDFromNumbers(a.Random32(),bit32.bor(0x4000,bit32.band(a.Random32(),0xFFFF0FFF)),bit32.bor(0x80000000,bit32.band(a.Random32(),0x3FFFFFFF)),a.Random32())end,UUIDString=function(aL)return n.__tostring(aL)end,UUIDFromNumbers=function(...)local aM=...local a8=type(aM)local aN,aO,aP,aQ;if a8=='table'then aN=aM[1]aO=aM[2]aP=aM[3]aQ=aM[4]else aN,aO,aP,aQ=...end;local aL={bit32.band(aN or 0,0xFFFFFFFF),bit32.band(aO or 0,0xFFFFFFFF),bit32.band(aP or 0,0xFFFFFFFF),bit32.band(aQ or 0,0xFFFFFFFF)}setmetatable(aL,n)return aL end,UUIDFromString=function(E)local H=string.len(E)if H~=32 and H~=36 then return nil end;local aR='[0-9a-f-A-F]+'local aS='^('..aR..')$'local aT='^-('..aR..')$'local aU,aV,aW,aX;if H==32 then local aL=a.UUIDFromNumbers(0,0,0,0)local aY=1;for l,aZ in ipairs({8,16,24,32})do aU,aV,aW=string.find(string.sub(E,aY,aZ),aS)if not aU then return nil end;aL[l]=tonumber(aW,16)aY=aZ+1 end;return aL else aU,aV,aW=string.find(string.sub(E,1,8),aS)if not aU then return nil end;local aN=tonumber(aW,16)aU,aV,aW=string.find(string.sub(E,9,13),aT)if not aU then return nil end;aU,aV,aX=string.find(string.sub(E,14,18),aT)if not aU then return nil end;local aO=tonumber(aW..aX,16)aU,aV,aW=string.find(string.sub(E,19,23),aT)if not aU then return nil end;aU,aV,aX=string.find(string.sub(E,24,28),aT)if not aU then return nil end;local aP=tonumber(aW..aX,16)aU,aV,aW=string.find(string.sub(E,29,36),aS)if not aU then return nil end;local aQ=tonumber(aW,16)return a.UUIDFromNumbers(aN,aO,aP,aQ)end end,ParseUUID=function(E)return a.UUIDFromString(E)end,CreateCircularQueue=function(a_)if type(a_)~='number'or a_<1 then error('Invalid argument: capacity = '..tostring(a_),2)end;local self;local b0=math.floor(a_)local J={}local b1=0;local b2=0;local b3=0;self={Size=function()return b3 end,Clear=function()b1=0;b2=0;b3=0 end,IsEmpty=function()return b3==0 end,Offer=function(b4)J[b1+1]=b4;b1=(b1+1)%b0;if b3<b0 then b3=b3+1 else b2=(b2+1)%b0 end;return true end,OfferFirst=function(b4)b2=(b0+b2-1)%b0;J[b2+1]=b4;if b3<b0 then b3=b3+1 else b1=(b0+b1-1)%b0 end;return true end,Poll=function()if b3==0 then return nil else local b4=J[b2+1]b2=(b2+1)%b0;b3=b3-1;return b4 end end,PollLast=function()if b3==0 then return nil else b1=(b0+b1-1)%b0;local b4=J[b1+1]b3=b3-1;return b4 end end,Peek=function()if b3==0 then return nil else return J[b2+1]end end,PeekLast=function()if b3==0 then return nil else return J[(b0+b1-1)%b0+1]end end,Get=function(b5)if b5<1 or b5>b3 then a.LogError('CreateCircularQueue.Get: index is outside the range: '..b5)return nil end;return J[(b2+b5-1)%b0+1]end,IsFull=function()return b3>=b0 end,MaxSize=function()return b0 end}return self end,
ColorFromARGB32=function(b6)local b7=type(b6)=='number'and b6 or 0xFF000000;return Color.__new(bit32.band(bit32.rshift(b7,16),0xFF)/0xFF,bit32.band(bit32.rshift(b7,8),0xFF)/0xFF,bit32.band(b7,0xFF)/0xFF,bit32.band(bit32.rshift(b7,24),0xFF)/0xFF)end,ColorToARGB32=function(b8)return bit32.bor(bit32.lshift(bit32.band(a.Round(0xFF*b8.a),0xFF),24),bit32.lshift(bit32.band(a.Round(0xFF*b8.r),0xFF),16),bit32.lshift(bit32.band(a.Round(0xFF*b8.g),0xFF),8),bit32.band(a.Round(0xFF*b8.b),0xFF))end,ColorFromIndex=function(b9,ba,bb,bc,bd)local be=math.max(math.floor(ba or a.ColorHueSamples),1)local bf=bd and be or be-1;local bg=math.max(math.floor(bb or a.ColorSaturationSamples),1)local bh=math.max(math.floor(bc or a.ColorBrightnessSamples),1)local b5=a.Clamp(math.floor(b9 or 0),0,be*bg*bh-1)local bi=b5%be;local bj=math.floor(b5/be)local aB=bj%bg;local bk=math.floor(bj/bg)if bd or bi~=bf then local A=bi/bf;local bl=(bg-aB)/bg;local C=(bh-bk)/bh;return Color.HSVToRGB(A,bl,C)else local C=(bh-bk)/bh*aB/(bg-1)return Color.HSVToRGB(0.0,0.0,C)end end,DetectClicks=function(bm,bn,bo)local bp=bm or 0;local bq=bo or TimeSpan.FromMilliseconds(500)local br=vci.me.Time;local bs=bn and br>bn+bq and 1 or bp+1;return bs,br end,GetEffekseerEmitterMap=function(U)local bt=vci.assets.GetEffekseerEmitters(U)if not bt then return nil end;local bu={}for l,bv in pairs(bt)do bu[bv.EffectName]=bv end;return bu end,GetSubItemTransform=function(bw)local bx=bw.GetPosition()local aK=bw.GetRotation()local by=bw.GetLocalScale()return{positionX=bx.x,positionY=bx.y,positionZ=bx.z,rotationX=aK.x,rotationY=aK.y,rotationZ=aK.z,rotationW=aK.w,scaleX=by.x,scaleY=by.y,scaleZ=by.z}end,TableToSerializable=function(bz,a1)if type(bz)~='table'then return bz end;if not a1 then a1={}end;if a1[bz]then error('circular reference')end;a1[bz]=true;local bA={}for Y,C in pairs(bz)do local bB=type(Y)local bC;if bB=='string'then bC=D(Y)elseif bB=='number'then bC=tostring(Y)..a.ArrayNumberTag else bC=Y end;local bD=type(C)if bD=='string'then bA[bC]=D(C)elseif bD=='number'and C<0 then bA[tostring(bC)..a.NegativeNumberTag]=tostring(C)else bA[bC]=a.TableToSerializable(C,a1)end end;a1[bz]=nil;return bA end,TableFromSerializable=function(bA)if type(bA)~='table'then return bA end;local bz={}for Y,C in pairs(bA)do local bC;local bE=false;if type(Y)=='string'then local bF=false;bC=F(Y,function(bG)if bG==a.NegativeNumberTag then bE=true elseif bG==a.ArrayNumberTag then bF=true end;return nil end)if bF then bC=tonumber(bC)or bC end else bC=Y;bE=false end;if bE and type(C)=='string'then bz[bC]=tonumber(C)elseif type(C)=='string'then bz[bC]=F(C,function(bG)return d[bG]end)else bz[bC]=a.TableFromSerializable(C)end end;return bz end,TableToSerialiable=function(bz,a1)return a.TableToSerializable(bz,a1)end,TableFromSerialiable=function(bA)return a.TableFromSerializable(bA)end,EmitMessage=function(U,bH)local table=bH and a.TableToSerializable(bH)or{}table[a.InstanceIDParameterName]=a.InstanceID()vci.message.Emit(U,json.serialize(table))end,OnMessage=function(U,bI)local bJ=function(bK,bL,bM)local bN=nil;if bK.type~='comment'and type(bM)=='string'then local bO,bA=pcall(json.parse,bM)if bO and type(bA)=='table'then bN=a.TableFromSerializable(bA)end end;local bH=bN and bN or{[a.MessageValueParameterName]=bM}bI(bK,bL,bH)end;vci.message.On(U,bJ)return{Off=function()if bJ then bJ=nil end end}end,OnInstanceMessage=function(U,bI)local bJ=function(bK,bL,bH)local bP=a.InstanceID()if bP~=''and bP==bH[a.InstanceIDParameterName]then bI(bK,bL,bH)end end;return a.OnMessage(U,bJ)end}a.SetConstEach(a,{LogLevelOff=0,LogLevelFatal=100,LogLevelError=200,LogLevelWarn=300,LogLevelInfo=400,LogLevelDebug=500,LogLevelTrace=600,LogLevelAll=0x7FFFFFFF,ColorHueSamples=10,ColorSaturationSamples=4,ColorBrightnessSamples=5,EscapeSequenceTag='#__CYTANB',SolidusTag='#__CYTANB_SOLIDUS',NegativeNumberTag='#__CYTANB_NEGATIVE_NUMBER',ArrayNumberTag='#__CYTANB_ARRAY_NUMBER',InstanceIDParameterName='__CYTANB_INSTANCE_ID',MessageValueParameterName='__CYTANB_MESSAGE_VALUE'})a.SetConstEach(a,{ColorMapSize=a.ColorHueSamples*a.ColorSaturationSamples*a.ColorBrightnessSamples,FatalLogLevel=a.LogLevelFatal,ErrorLogLevel=a.LogLevelError,WarnLogLevel=a.LogLevelWarn,InfoLogLevel=a.LogLevelInfo,DebugLogLevel=a.LogLevelDebug,TraceLogLevel=a.LogLevelTrace})c={{tag=a.NegativeNumberTag,pattern='^'..a.NegativeNumberTag,replacement=''},{tag=a.ArrayNumberTag,pattern='^'..a.ArrayNumberTag,replacement=''},{tag=a.SolidusTag,pattern='^'..a.SolidusTag,replacement='/'},{tag=a.EscapeSequenceTag,pattern='^'..a.EscapeSequenceTag..a.EscapeSequenceTag,replacement=a.EscapeSequenceTag}}d=a.ListToMap({a.NegativeNumberTag,a.ArrayNumberTag})e=a.LogLevelInfo;g={[a.LogLevelFatal]='FATAL',[a.LogLevelError]='ERROR',[a.LogLevelWarn]='WARN',[a.LogLevelInfo]='INFO',[a.LogLevelDebug]='DEBUG',[a.LogLevelTrace]='TRACE'}package.loaded['cytanb']=a;h=vci.state.Get(b)or''if h==''and vci.assets.IsMine then h=tostring(a.RandomUUID())vci.state.Set(b,h)end;return a end)()
