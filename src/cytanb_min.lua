-- cytanb | Copyright (c) 2019 oO (https://github.com/oocytanb) | MIT Licensed
---@type cytanb @See `cytanb_annotations.lua`
local cytanb=(function()math.randomseed(os.time()-os.clock()*10000)local b='__CYTANB_INSTANCE_ID'local c;local d;local e;local f=false;local g;local h;local a;local i=function(j,k)for l=1,4 do local m=j[l]-k[l]if m~=0 then return m end end;return 0 end;local n;n={__eq=function(j,k)return j[1]==k[1]and j[2]==k[2]and j[3]==k[3]and j[4]==k[4]end,__lt=function(j,k)return i(j,k)<0 end,__le=function(j,k)return i(j,k)<=0 end,__tostring=function(o)local p=o[2]or 0;local q=o[3]or 0;return string.format('%08x-%04x-%04x-%04x-%04x%08x',bit32.band(o[1]or 0,0xFFFFFFFF),bit32.band(bit32.rshift(p,16),0xFFFF),bit32.band(p,0xFFFF),bit32.band(bit32.rshift(q,16),0xFFFF),bit32.band(q,0xFFFF),bit32.band(o[4]or 0,0xFFFFFFFF))end,__concat=function(j,k)local r=getmetatable(j)local s=r==n or type(r)=='table'and r.__concat==n.__concat;local t=getmetatable(k)local u=t==n or type(t)=='table'and t.__concat==n.__concat;if not s and not u then error('attempt to concatenate illegal values')end;return(s and n.__tostring(j)or j)..(u and n.__tostring(k)or k)end}local v='__CYTANB_CONST_VARIABLES'local w=function(table,x)local y=getmetatable(table)if y then local z=rawget(y,v)if z then local A=rawget(z,x)if type(A)=='function'then return A(table,x)else return A end end end;return nil end;local B=function(table,x,C)local y=getmetatable(table)if y then local z=rawget(y,v)if z then if rawget(z,x)~=nil then error('Cannot assign to read only field "'..x..'"')end end end;rawset(table,x,C)end;local D=function(E)return string.gsub(string.gsub(E,a.EscapeSequenceTag,a.EscapeSequenceTag..a.EscapeSequenceTag),'/',a.SolidusTag)end;local F=function(E,G)local H=string.len(E)local I=string.len(a.EscapeSequenceTag)if I>H then return E end;local J=''local l=1;while l<H do local K,L=string.find(E,a.EscapeSequenceTag,l,true)if not K then if l==1 then J=E else J=J..string.sub(E,l)end;break end;if K>l then J=J..string.sub(E,l,K-1)end;local M=false;for N,O in ipairs(c)do local P,Q=string.find(E,O.pattern,K)if P then J=J..(G and G(O.tag)or O.replacement)l=Q+1;M=true;break end end;if not M then J=J..a.EscapeSequenceTag;l=L+1 end end;return J end;a={InstanceID=function()if h==''then h=vci.state.Get(b)or''end;return h end,SetConst=function(R,S,o)if type(R)~='table'then error('Cannot set const to non-table target')end;local T=getmetatable(R)local y=T or{}local U=rawget(y,v)if rawget(R,S)~=nil then error('Non-const field "'..S..'" already exists')end;if not U then U={}rawset(y,v,U)y.__index=w;y.__newindex=B end;rawset(U,S,o)if not T then setmetatable(R,y)end;return R end,SetConstEach=function(R,V)for W,C in pairs(V)do a.SetConst(R,W,C)end;return R end,Extend=function(R,X,Y,Z,_)if R==X or type(R)~='table'or type(X)~='table'then return R end;if Y then if not _ then _={}end;if _[X]then error('circular reference')end;_[X]=true end;for W,C in pairs(X)do if Y and type(C)=='table'then local a0=R[W]R[W]=a.Extend(type(a0)=='table'and a0 or{},C,Y,Z,_)else R[W]=C end end;if not Z then local a1=getmetatable(X)if type(a1)=='table'then if Y then local a2=getmetatable(R)setmetatable(R,a.Extend(type(a2)=='table'and a2 or{},a1,true))else setmetatable(R,a1)end end end;if Y then _[X]=nil end;return R end,Vars=function(C,a3,a4,_)local a5;if a3 then a5=a3~='__NOLF'else a3='  'a5=true end;if not a4 then a4=''end;if not _ then _={}end;local a6=type(C)if a6=='table'then _[C]=_[C]and _[C]+1 or 1;local a7=a5 and a4 ..a3 or''local E='('..tostring(C)..') {'local a8=true;for x,a9 in pairs(C)do if a8 then a8=false else E=E..(a5 and','or', ')end;if a5 then E=E..'\n'..a7 end;if type(a9)=='table'and _[a9]and _[a9]>0 then E=E..x..' = ('..tostring(a9)..')'else E=E..x..' = '..a.Vars(a9,a3,a7,_)end end;if not a8 and a5 then E=E..'\n'..a4 end;E=E..'}'_[C]=_[C]-1;if _[C]<=0 then _[C]=nil end;return E elseif a6=='function'or a6=='thread'or a6=='userdata'then return'('..a6 ..')'elseif a6=='string'then return'('..a6 ..') '..string.format('%q',C)else return'('..a6 ..') '..tostring(C)end end,GetLogLevel=function()return e end,SetLogLevel=function(aa)e=aa end,IsOutputLogLevelEnabled=function()return f end,SetOutputLogLevelEnabled=function(ab)f=not not ab end,Log=function(aa,...)if aa<=e then local ac=f and(g[aa]or'LOG LEVEL '..tostring(aa))..' | 'or''local ad=table.pack(...)if ad.n==1 then local C=ad[1]if C~=nil then local E=type(C)=='table'and a.Vars(C)or tostring(C)print(f and ac..E or E)else print(ac)end else local E=ac;for l=1,ad.n do local C=ad[l]if C~=nil then E=E..(type(C)=='table'and a.Vars(C)or tostring(C))end end;print(E)end end end,LogFatal=function(...)a.Log(a.LogLevelFatal,...)end,LogError=function(...)a.Log(a.LogLevelError,...)end,LogWarn=function(...)a.Log(a.LogLevelWarn,...)end,LogInfo=function(...)a.Log(a.LogLevelInfo,...)end,LogDebug=function(...)a.Log(a.LogLevelDebug,...)end,LogTrace=function(...)a.Log(a.LogLevelTrace,...)end,FatalLog=function(...)a.LogFatal(...)end,ErrorLog=function(...)a.LogError(...)end,WarnLog=function(...)a.LogWarn(...)end,InfoLog=function(...)a.LogInfo(...)end,DebugLog=function(...)a.LogDebug(...)end,TraceLog=function(...)a.LogTrace(...)end,ListToMap=function(ae,af)local table={}local ag=af==nil;for W,C in pairs(ae)do table[C]=ag and C or af end;return table end,Round=function(ah,ai)if ai then local aj=10^ai;return math.floor(ah*aj+0.5)/aj else return math.floor(ah+0.5)end end,Clamp=function(o,ak,al)return math.max(ak,math.min(o,al))end,Lerp=function(am,an,a6)if a6<=0.0 then return am elseif a6>=1.0 then return an else return am+(an-am)*a6 end end,LerpUnclamped=function(am,an,a6)if a6==0.0 then return am elseif a6==1.0 then return an else return am+(an-am)*a6 end end,PingPong=function(a6,ao)if ao==0 then return 0 end;local ap=math.floor(a6/ao)local aq=a6-ap*ao;if ap<0 then if(ap+1)%2==0 then return ao-aq else return aq end else if ap%2==0 then return aq else return ao-aq end end end,QuaternionToAngleAxis=function(ar)local ap=ar.normalized;local as=math.acos(ap.w)local at=math.sin(as)local au=math.deg(as*2.0)local av;if math.abs(at)<=Quaternion.kEpsilon then av=Vector3.right else local aw=1.0/at;av=Vector3.__new(ap.x*aw,ap.y*aw,ap.z*aw)end;return au,av end,ApplyQuaternionToVector3=function(ar,ax)local ay=ar.w*ax.x+ar.y*ax.z-ar.z*ax.y;local az=ar.w*ax.y-ar.x*ax.z+ar.z*ax.x;local aA=ar.w*ax.z+ar.x*ax.y-ar.y*ax.x;local aB=-ar.x*ax.x-ar.y*ax.y-ar.z*ax.z;return Vector3.__new(aB*-ar.x+ay*ar.w+az*-ar.z-aA*-ar.y,aB*-ar.y-ay*-ar.z+az*ar.w+aA*-ar.x,aB*-ar.z+ay*-ar.y-az*-ar.x+aA*ar.w)end,Random32=function()return bit32.band(math.random(-2147483648,2147483646),0xFFFFFFFF)end,RandomUUID=function()return a.UUIDFromNumbers(a.Random32(),bit32.bor(0x4000,bit32.band(a.Random32(),0xFFFF0FFF)),bit32.bor(0x80000000,bit32.band(a.Random32(),0x3FFFFFFF)),a.Random32())end,UUIDString=function(aC)return n.__tostring(aC)end,UUIDFromNumbers=function(...)local aD=...local a6=type(aD)local aE,aF,aG,aH;if a6=='table'then aE=aD[1]aF=aD[2]aG=aD[3]aH=aD[4]else aE,aF,aG,aH=...end;local aC={bit32.band(aE or 0,0xFFFFFFFF),bit32.band(aF or 0,0xFFFFFFFF),bit32.band(aG or 0,0xFFFFFFFF),bit32.band(aH or 0,0xFFFFFFFF)}setmetatable(aC,n)return aC end,UUIDFromString=function(E)local H=string.len(E)if H~=32 and H~=36 then return nil end;local aI='[0-9a-f-A-F]+'local aJ='^('..aI..')$'local aK='^-('..aI..')$'local aL,aM,aN,aO;if H==32 then local aC=a.UUIDFromNumbers(0,0,0,0)local aP=1;for l,aQ in ipairs({8,16,24,32})do aL,aM,aN=string.find(string.sub(E,aP,aQ),aJ)if not aL then return nil end;aC[l]=tonumber(aN,16)aP=aQ+1 end;return aC else aL,aM,aN=string.find(string.sub(E,1,8),aJ)if not aL then return nil end;local aE=tonumber(aN,16)aL,aM,aN=string.find(string.sub(E,9,13),aK)if not aL then return nil end;aL,aM,aO=string.find(string.sub(E,14,18),aK)if not aL then return nil end;local aF=tonumber(aN..aO,16)aL,aM,aN=string.find(string.sub(E,19,23),aK)if not aL then return nil end;aL,aM,aO=string.find(string.sub(E,24,28),aK)if not aL then return nil end;local aG=tonumber(aN..aO,16)aL,aM,aN=string.find(string.sub(E,29,36),aJ)if not aL then return nil end;local aH=tonumber(aN,16)return a.UUIDFromNumbers(aE,aF,aG,aH)end end,ParseUUID=function(E)return a.UUIDFromString(E)end,CreateCircularQueue=function(aR)if type(aR)~='number'or aR<1 then error('Invalid argument: capacity = '..tostring(aR))end;local self;local aS=math.floor(aR)local J={}local aT=0;local aU=0;local aV=0;self={Size=function()return aV end,Clear=function()aT=0;aU=0;aV=0 end,IsEmpty=function()return aV==0 end,Offer=function(aW)J[aT+1]=aW;aT=(aT+1)%aS;if aV<aS then aV=aV+1 else aU=(aU+1)%aS end;return true end,OfferFirst=function(aW)aU=(aS+aU-1)%aS;J[aU+1]=aW;if aV<aS then aV=aV+1 else aT=(aS+aT-1)%aS end;return true end,Poll=function()if aV==0 then return nil else local aW=J[aU+1]aU=(aU+1)%aS;aV=aV-1;return aW end end,PollLast=function()if aV==0 then return nil else aT=(aS+aT-1)%aS;local aW=J[aT+1]aV=aV-1;return aW end end,Peek=function()if aV==0 then return nil else return J[aU+1]end end,PeekLast=function()if aV==0 then return nil else return J[(aS+aT-1)%aS+1]end end,Get=function(aX)if aX<1 or aX>aV then a.LogError('CreateCircularQueue.Get: index is outside the range: '..aX)return nil end;return J[(aU+aX-1)%aS+1]end,IsFull=function()return aV>=aS end,MaxSize=function()return aS end}return self end,
ColorFromARGB32=function(aY)local aZ=type(aY)=='number'and aY or 0xFF000000;return Color.__new(bit32.band(bit32.rshift(aZ,16),0xFF)/0xFF,bit32.band(bit32.rshift(aZ,8),0xFF)/0xFF,bit32.band(aZ,0xFF)/0xFF,bit32.band(bit32.rshift(aZ,24),0xFF)/0xFF)end,ColorToARGB32=function(a_)return bit32.bor(bit32.lshift(bit32.band(a.Round(0xFF*a_.a),0xFF),24),bit32.lshift(bit32.band(a.Round(0xFF*a_.r),0xFF),16),bit32.lshift(bit32.band(a.Round(0xFF*a_.g),0xFF),8),bit32.band(a.Round(0xFF*a_.b),0xFF))end,ColorFromIndex=function(b0,b1,b2,b3,b4)local b5=math.max(math.floor(b1 or a.ColorHueSamples),1)local b6=b4 and b5 or b5-1;local b7=math.max(math.floor(b2 or a.ColorSaturationSamples),1)local b8=math.max(math.floor(b3 or a.ColorBrightnessSamples),1)local aX=a.Clamp(math.floor(b0 or 0),0,b5*b7*b8-1)local b9=aX%b5;local ba=math.floor(aX/b5)local aw=ba%b7;local bb=math.floor(ba/b7)if b4 or b9~=b6 then local A=b9/b6;local bc=(b7-aw)/b7;local C=(b8-bb)/b8;return Color.HSVToRGB(A,bc,C)else local C=(b8-bb)/b8*aw/(b7-1)return Color.HSVToRGB(0.0,0.0,C)end end,DetectClicks=function(bd,be,bf)local bg=bd or 0;local bh=bf or TimeSpan.FromMilliseconds(500)local bi=vci.me.Time;local bj=be and bi>be+bh and 1 or bg+1;return bj,bi end,GetEffekseerEmitterMap=function(S)local bk=vci.assets.GetEffekseerEmitters(S)if not bk then return nil end;local bl={}for l,bm in pairs(bk)do bl[bm.EffectName]=bm end;return bl end,GetSubItemTransform=function(bn)local bo=bn.GetPosition()local bp=bn.GetRotation()local bq=bn.GetLocalScale()return{positionX=bo.x,positionY=bo.y,positionZ=bo.z,rotationX=bp.x,rotationY=bp.y,rotationZ=bp.z,rotationW=bp.w,scaleX=bq.x,scaleY=bq.y,scaleZ=bq.z}end,TableToSerializable=function(br,_)if type(br)~='table'then return br end;if not _ then _={}end;if _[br]then error('circular reference')end;_[br]=true;local bs={}for W,C in pairs(br)do local bt=type(W)local bu;if bt=='string'then bu=D(W)elseif bt=='number'then bu=tostring(W)..a.ArrayNumberTag else bu=W end;local bv=type(C)if bv=='string'then bs[bu]=D(C)elseif bv=='number'and C<0 then bs[tostring(bu)..a.NegativeNumberTag]=tostring(C)else bs[bu]=a.TableToSerializable(C,_)end end;_[br]=nil;return bs end,TableFromSerializable=function(bs)if type(bs)~='table'then return bs end;local br={}for W,C in pairs(bs)do local bu;local bw=false;if type(W)=='string'then local bx=false;bu=F(W,function(by)if by==a.NegativeNumberTag then bw=true elseif by==a.ArrayNumberTag then bx=true end;return nil end)if bx then bu=tonumber(bu)or bu end else bu=W;bw=false end;if bw and type(C)=='string'then br[bu]=tonumber(C)elseif type(C)=='string'then br[bu]=F(C,function(by)return d[by]end)else br[bu]=a.TableFromSerializable(C)end end;return br end,TableToSerialiable=function(br,_)return a.TableToSerializable(br,_)end,TableFromSerialiable=function(bs)return a.TableFromSerializable(bs)end,EmitMessage=function(S,bz)local table=bz and a.TableToSerializable(bz)or{}table[a.InstanceIDParameterName]=a.InstanceID()vci.message.Emit(S,json.serialize(table))end,OnMessage=function(S,bA)local bB=function(bC,bD,bE)local bF=nil;if bC.type~='comment'and type(bE)=='string'then local bG,bs=pcall(json.parse,bE)if bG and type(bs)=='table'then bF=a.TableFromSerializable(bs)end end;local bz=bF and bF or{[a.MessageValueParameterName]=bE}bA(bC,bD,bz)end;vci.message.On(S,bB)return{Off=function()if bB then bB=nil end end}end,OnInstanceMessage=function(S,bA)local bB=function(bC,bD,bz)local bH=a.InstanceID()if bH~=''and bH==bz[a.InstanceIDParameterName]then bA(bC,bD,bz)end end;return a.OnMessage(S,bB)end}a.SetConstEach(a,{LogLevelOff=0,LogLevelFatal=100,LogLevelError=200,LogLevelWarn=300,LogLevelInfo=400,LogLevelDebug=500,LogLevelTrace=600,LogLevelAll=0x7FFFFFFF,ColorHueSamples=10,ColorSaturationSamples=4,ColorBrightnessSamples=5,EscapeSequenceTag='#__CYTANB',SolidusTag='#__CYTANB_SOLIDUS',NegativeNumberTag='#__CYTANB_NEGATIVE_NUMBER',ArrayNumberTag='#__CYTANB_ARRAY_NUMBER',InstanceIDParameterName='__CYTANB_INSTANCE_ID',MessageValueParameterName='__CYTANB_MESSAGE_VALUE'})a.SetConstEach(a,{ColorMapSize=a.ColorHueSamples*a.ColorSaturationSamples*a.ColorBrightnessSamples,FatalLogLevel=a.LogLevelFatal,ErrorLogLevel=a.LogLevelError,WarnLogLevel=a.LogLevelWarn,InfoLogLevel=a.LogLevelInfo,DebugLogLevel=a.LogLevelDebug,TraceLogLevel=a.LogLevelTrace})c={{tag=a.NegativeNumberTag,pattern='^'..a.NegativeNumberTag,replacement=''},{tag=a.ArrayNumberTag,pattern='^'..a.ArrayNumberTag,replacement=''},{tag=a.SolidusTag,pattern='^'..a.SolidusTag,replacement='/'},{tag=a.EscapeSequenceTag,pattern='^'..a.EscapeSequenceTag..a.EscapeSequenceTag,replacement=a.EscapeSequenceTag}}d=a.ListToMap({a.NegativeNumberTag,a.ArrayNumberTag})e=a.LogLevelInfo;g={[a.LogLevelFatal]='FATAL',[a.LogLevelError]='ERROR',[a.LogLevelWarn]='WARN',[a.LogLevelInfo]='INFO',[a.LogLevelDebug]='DEBUG',[a.LogLevelTrace]='TRACE'}package.loaded['cytanb']=a;h=vci.state.Get(b)or''if h==''and vci.assets.IsMine then h=tostring(a.RandomUUID())vci.state.Set(b,h)end;return a end)()
